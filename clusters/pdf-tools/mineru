#!/usr/bin/env bash
set -euo pipefail

# Wrapper voor MinerU (venv-based). Nix package volgt apart.

VENV="${MINERU_VENV:-$HOME/.venvs/mineru}"
EXTRA="${MINERU_EXTRA:-core}"

have() { command -v "$1" >/dev/null 2>&1; }
err() { printf "mineru-wrapper: %s\n" "$*" >&2; }

ensure_python() {
  if ! have python3; then
    err "python3 niet gevonden."
    exit 1
  fi
}

make_venv() {
  mkdir -p "$(dirname "$VENV")"
  if [ ! -d "$VENV" ]; then
    if have uv; then
      uv venv "$VENV"
    else
      ensure_python
      python3 -m venv "$VENV"
    fi
  fi
}

install_mineru() {
  if have uv; then
    # shellcheck disable=SC1091
    source "$VENV/bin/activate"
    uv pip install -U "mineru[$EXTRA]"
    deactivate
  else
    "$VENV/bin/python" -m pip install --upgrade pip
    "$VENV/bin/pip" install -U "mineru[$EXTRA]"
  fi
}

ensure_installed() {
  make_venv
  if [ ! -x "$VENV/bin/mineru" ]; then
    install_mineru
  fi
}

usage() {
  cat <<EOF
Gebruik: mineru [opties voor mineru ...]
Wrapper-opties (vooraf plaatsen):
  --setup         Forceer (her)aanmaken venv en installatie/upgrade MinerU
  --reinstall     Herinstalleer MinerU (pip -U)
  --upgrade       Upgrade MinerU naar nieuwste versie
  --which         Toon pad naar de gebruikte mineru-binary
  --version-wrap  Toon wrapper-versie en instellingen

Environment:
  MINERU_VENV   Pad naar venv (default: $HOME/.venvs/mineru)
  MINERU_EXTRA  'core' (default) of 'vllm'
EOF
}

if [[ "${1:-}" == "--help-wrap" ]]; then usage; exit 0; fi
if [[ "${1:-}" == "--version-wrap" ]]; then
  echo "mineru-wrapper 1.0"
  echo "VENV=$VENV"
  echo "EXTRA=$EXTRA"
  exit 0
fi
if [[ "${1:-}" == "--which" ]]; then
  ensure_installed
  echo "$VENV/bin/mineru"
  exit 0
fi
if [[ "${1:-}" == "--setup" ]]; then
  shift || true
  make_venv
  install_mineru
fi
if [[ "${1:-}" == "--reinstall" ]]; then
  shift || true
  make_venv
  install_mineru
fi
if [[ "${1:-}" == "--upgrade" ]]; then
  shift || true
  ensure_installed
  install_mineru
fi

ensure_installed
exec "$VENV/bin/mineru" "$@"
